I"‹'<h3 id="data">Data</h3>

<p>Obviously if we talk about heatmaps, we talk about displaying some data. Today it is about displaying heatmap on an image. In this case it will be dog position in the garden. You can read how to obtain such position <a href="https://jakubszwajka.github.io/Maping-coordinates-from-frame-to-flat-space/">here</a>. Connect the dots, and you will have some cool system in your garden ğŸ˜.</p>

<!--more-->

<p>First, I have to admit that I donâ€™t have a dog. Data will be generated randomly X and Y positions.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="c1"># 100 random pairs of x and y in range from 0 to 20
</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="p">,(</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
</code></pre></div></div>

<h3 id="image-to-put-heatmap-on-it">Image to put heatmap on it</h3>

<p>Now I will use my talent a bit ğŸ˜. Hope you can see a garden here.</p>

<p><img src="https://github.com/JakubSzwajka/JakubSzwajka.github.io/blob/master/_posts/_images/garden.png?raw=true" alt="garden" /></p>

<h3 id="load-image-and-put-data-strait-forward-on-it">Load image and put data strait forward on it</h3>

<p>Letâ€™s use OpenCV and add some dots. Assume that our garden is 20 m long. Scale coordinates to shape of our image.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">cv2</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="p">,(</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

<span class="n">map_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">"HERE PUT PATH TO IMG ON DISC"</span><span class="p">)</span>
<span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">map_img</span><span class="p">.</span><span class="n">shape</span>

<span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">coord</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">20</span> <span class="p">)</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span> <span class="n">y</span> <span class="o">/</span> <span class="mi">20</span> <span class="p">)</span> <span class="o">*</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">cv2</span><span class="p">.</span><span class="n">circle</span><span class="p">(</span> <span class="n">map_img</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> <span class="mi">20</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span>  <span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">cv2</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">"map"</span><span class="p">,</span> <span class="n">map_img</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">cv2</span><span class="p">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s">"q"</span><span class="p">):</span>
        <span class="k">break</span>

<span class="n">cv2</span><span class="p">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="https://github.com/JakubSzwajka/JakubSzwajka.github.io/blob/master/_posts/_images/garden_2.png?raw=true" alt="garden" /></p>

<p>Hmm. There is some data, but itâ€™s hard to analyze it. Letâ€™s dig deeper.</p>

<p>Letâ€™s make second image, blank one. We will put our data on it, manipulate a bit and then overlay on target image.</p>

<p>Blank image is quite easy in OpenCV. Just matrix with zeros.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">heatmap_image</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span><span class="n">width</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>
</code></pre></div></div>

<p>Putting data on it is the same as above. Use <code class="language-plaintext highlighter-rouge">cv2.circle(...)</code>. You should be able to display such dots.</p>

<p><img src="https://github.com/JakubSzwajka/JakubSzwajka.github.io/blob/master/_posts/_images/garden_3.png?raw=true" alt="garden" /></p>

<h3 id="manipulate-them">Manipulate them</h3>

<p>Use <code class="language-plaintext highlighter-rouge">cv2.distanceTransform()</code> for all pixels. It changes pixels value based on distance to the nearest pixel with value 0. So if there is a lot of points in one place, value will be higher.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">heatmap_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">distanceTransform</span><span class="p">(</span><span class="n">heatmap_image</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">DIST_L2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://github.com/JakubSzwajka/JakubSzwajka.github.io/blob/master/_posts/_images/garden_5.png?raw=true" alt="garden" /></p>

<p>Quite good! Now letâ€™s add some color. To make in more readable, in this example Iâ€™m multiplying every pixel by 2.5. Change this value and see what happens. ğŸ˜‰</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># here I make those points a bit bigger
</span><span class="n">heatmap_image</span> <span class="o">=</span> <span class="n">heatmap_image</span> <span class="o">*</span> <span class="mf">2.5</span>
<span class="n">heatmap_image</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">heatmap_image</span><span class="p">)</span>
<span class="n">heatmap_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">applyColorMap</span><span class="p">(</span><span class="n">heatmap_image</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLORMAP_JET</span><span class="p">)</span>
</code></pre></div></div>

<p>Remember that <code class="language-plaintext highlighter-rouge">cv2.distanceTransform( )</code> change type of data a bit. We have to change it back to <code class="language-plaintext highlighter-rouge">np.uint8</code>.</p>

<h3 id="overlay">Overlay</h3>

<p>Final step. Overlay those two images.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fin_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">heatmap_image</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">map_img</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://github.com/JakubSzwajka/JakubSzwajka.github.io/blob/master/_posts/_images/garden_4.png?raw=true" alt="Garden" /></p>

<p>We can see the data now! We can assume where our dog spends most of the time. ğŸ‘</p>

<p>Try to connect this with this <a href="https://jakubszwajka.github.io/Maping-coordinates-from-frame-to-flat-space/">post</a>, and you can make quite interesting camera system ğŸ¤”. You can try changing values in <code class="language-plaintext highlighter-rouge">distanceTransform( )</code> too. For example try different <a href="https://docs.opencv.org/3.4/d7/d1b/group__imgproc__misc.html#gaa2bfbebbc5c320526897996aafa1d8eb">distance types</a>. They will change your heatmap a bit.</p>
:ET